# Dotfiles Repository Guidelines

This is my NixOS system configurations repository. It is home to the source code
for all of my system configurations called hosts in short. This includes my PCs,
laptops, and servers. In the future, I'm hoping to also have my phone configured
via this repository.

## Repository structure

The root of the repository contains:

- configuration files for tools
- the `justfile`
- the `flake.nix`
- `assets/` folder containing various non-code files
- `scripts/` folder containing scripts that are tools that aid in various tasks
  related to the repository
- `src/` folder where all the flake modules reside in.

### Assets

The `assets/` folder has a couple of things of note:

- the `assets/hardware/` folder contains JSON files that describe each of the
  hosts' hardware and they're all generated via the `nixos-facter` script
- the `assets/secrets/` folder contains YAML files generated via SOPS that
  contain encrypted secrets for all hosts

### Scripts

Currently this folder only contains the `hosts.nu` script. It is callable via
`just hosts *args`. The script has several commands that aid in access to hosts,
deployment, imaging, etc.

### Source

The flake uses a nix framework called `perch`. This means that each file in the
source directory is actually a `perch` module. These modules can define
`self.lib` functions, `self.nixosModules` modules, `self.homeManagerModules`
modules, etc.

The `hosts` module takes the `self.nixosModules.default` and
`self.homeManagerModules.default` attributes which are created by `perch` and
are an aggregation of all the NixOS system modules and Home Manager modules
defined by the `perch` modules in this repository and puts them in the hosts'
NixOS system configurations.

## Modules

Every module is applied to every host. There is a special module called
`hardware` that provides hardware-related attributes to all other modules via
`config`. It is expected that each module applies parts of itself depending on
the hardware present on the host.

Secrets are managed via the `sops` and `rumor` NixOS module configuration
options. `rumor` is a secret generation program that works with Vault to store
import/export secrets. All secrets are generated via `rumor` and encrypted into
SOPS files in `assets/secrets/`. The `rumor.sops` option declares which files
generated by `rumor` will be available as keys in the SOPS files. The repository
uses `nix-sops` to manage secrets on the hosts themselves.

## Commands

- `just format` - format the repository
- `just lint` - lint the repository
- `just hosts` - execute host-related commands

## Code style guide

- **Naming**:
  - kebab-case for Nix modules, packages, flake outputs (except lib functions)
  - camelCase for Nix variables, functions
  - snake_case for Nushell variables, functions
- **Formatting**:
  - 2-space indentation
  - 80 char line length
- **Comments**:
  - comments are in general considered bad - you should try to document as much
    as possible via variable/function names
  - if something is oddly specific/quirky leave a `# NOTE: <message>` comment
  - if something needs to be done in the future leave a `# TODO: <message>`
    comment
  - if something needs to be fixed in the future leave a `# FIXME: <message>`
    comment
